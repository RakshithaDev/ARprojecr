<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Art AR + Comments (No Backend)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #ui{position:fixed;left:0;right:0;bottom:0;padding:12px;background:rgba(0,0,0,.55);color:#fff;backdrop-filter:blur(6px)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:0;background:#42a5f5;color:#000;font-weight:700;cursor:pointer}
    .btn.secondary{background:#30343a;color:#f2f6ff}
    #hint{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:999px;font-size:14px}
    dialog#formModal{border:0;border-radius:16px;max-width:min(900px,92vw);width:92vw;height:min(80vh,700px);padding:0;overflow:hidden}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0f1116;color:#fff}
    .modal-body{height:calc(100% - 48px)}
    .modal-body iframe{width:100%;height:100%;border:0}
  </style>
</head>
<body>
  <!-- ---- CONFIG: set these ---- -->
  <script>
    const TARGET_PATH   = "targets (3).mind";                   // your .mind file
    const ADD_URL       = "https://docs.google.com/forms/d/e/1FAIpQLSeqRZbSpTWiVs9z6BzntH9ZFGW2LR_9BHIUM7bvAtvZdcdmPA/viewform?usp=sharing&ouid=106135578680070943218"; // your Google Form
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1aMxe4t5VoM59TqpzeFiIlgVOGhA84HcZkQ_m4eq6OM0/edit?usp=sharing"; // published CSV
    const MAX_BUBBLES   = 10; // how many comments to show around the target
    const COMMENT_HEADER_HINT = "comment", NAME_HEADER_HINT = "name", TIME_HEADER_HINT = "time";
  </script>

  <div id="hint">Point your camera at the artwork</div>

  <a-scene id="scene"
    mindar-image="imageTargetSrc: ./assets/art.mind"
    renderer="colorManagement: true, physicallyCorrectLights: true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    embedded loading-screen="enabled:false">
    <a-camera look-controls="enabled:false"></a-camera>
    <a-entity id="anchor" mindar-image-target="targetIndex: 0"></a-entity>
  </a-scene>

  <div id="ui">
    <div class="row">
      <button id="btn-form" class="btn">ðŸ’¬ Share your thoughts</button>
      <button id="btn-refresh" class="btn secondary">â†» Refresh comments</button>
      <span id="status" style="opacity:.85">Waiting for targetâ€¦</span>
    </div>
  </div>

  <dialog id="formModal">
    <div class="modal-head">
      <strong>Share your thoughts</strong>
      <button id="btn-close" class="btn secondary">Close</button>
    </div>
    <div class="modal-body">
      <iframe id="formFrame" title="Comment Form" src="about:blank" loading="lazy"></iframe>
    </div>
  </dialog>

  <script>
    // apply config
    document.getElementById("scene").setAttribute("mindar-image", `imageTargetSrc: ${TARGET_PATH}`);

    const statusEl = document.getElementById('status');
    const hintEl   = document.getElementById('hint');
    const anchor   = document.getElementById('anchor');
    const modal    = document.getElementById('formModal');
    const formFrame= document.getElementById('formFrame');

    document.getElementById('btn-form').onclick = () => {
      if (ADD_URL.startsWith("http")) { formFrame.src = ADD_URL; modal.showModal(); }
      else alert("Set ADD_URL to your Google Form link.");
    };
    document.getElementById('btn-close').onclick = () => modal.close();
    document.getElementById('btn-refresh').onclick = () => fetchAndRender();

    // ----- fetch comments from published CSV -----
    function parseCSV(text){
      const rows=[], row=[], push=()=>{rows.push(row.splice(0))}; let cell="", q=false;
      for(let i=0;i<text.length;i++){const c=text[i],n=text[i+1];
        if(q){ if(c=='"'&&n=='"'){cell+='"'; i++;} else if(c=='"'){q=false;} else cell+=c; }
        else { if(c=='"') q=true; else if(c==','){row.push(cell);cell="";}
               else if(c=='\n'){row.push(cell);cell=""; push();} else if(c!='\r'){cell+=c;} }
      }
      if(cell||row.length){row.push(cell); push();} return rows;
    }
    const idx = (headers,h)=>headers.findIndex(x=> (x||"").toLowerCase().includes(h.toLowerCase()));

    async function getComments(){
      if(!SHEET_CSV_URL.startsWith("http")) throw new Error("Set SHEET_CSV_URL to your CSV link.");
      const res = await fetch(SHEET_CSV_URL, {cache:"no-store"});
      const text = await res.text();
      const rows = parseCSV(text); if(!rows.length) return [];
      const headers = rows[0].map(h=> (h||"").trim());
      const ci = idx(headers, COMMENT_HEADER_HINT), ni = idx(headers, NAME_HEADER_HINT), ti = idx(headers, TIME_HEADER_HINT);
      const items=[];
      for(let i=1;i<rows.length;i++){
        const r=rows[i]; const t=(ci>=0?r[ci]:r[0]||"").trim(); if(!t) continue;
        items.push({ text:t, name:ni>=0?(r[ni]||"").trim():"", time:ti>=0?(r[ti]||"").trim():"" });
      }
      return items.reverse(); // latest first
    }

    function clearBubbles(){ Array.from(anchor.children).forEach(ch=>anchor.removeChild(ch)); }
    const trunc = (s,n)=> s && s.length>n ? s.slice(0,n-1)+"â€¦" : (s||"");

    function placeBubble(item, pos){
      const g = document.createElement("a-entity");
      g.setAttribute("position", `${pos.x} ${pos.y} ${pos.z}`);

      const card = document.createElement("a-plane");
      card.setAttribute("width", 0.68);
      card.setAttribute("height", 0.22);
      card.setAttribute("material","color:#ffb773;opacity:.92;transparent:true;side:double");
      g.appendChild(card);

      const txt = document.createElement("a-text");
      const who = item.name ? ` â€” ${item.name}` : "";
      const when = item.time ? ` Â· ${item.time}` : "";
      txt.setAttribute("value", trunc(item.text,70) + who + when);
      txt.setAttribute("align","center");
      txt.setAttribute("width", 1.2);
      txt.setAttribute("color","#222");
      txt.setAttribute("position","0 0 0.01");
      g.appendChild(txt);

      anchor.appendChild(g);
    }
    function pos(angle, r, j=0){ return { x:Math.cos(angle)*r + (Math.random()-0.5)*j, y:Math.sin(angle)*r + (Math.random()-0.5)*j*0.6, z:0.02 }; }

    async function fetchAndRender(){
      try{
        statusEl.textContent = "Loading commentsâ€¦";
        const all = await getComments();
        const items = all.slice(0, MAX_BUBBLES);
        clearBubbles();
        const R=0.45, J=0.08;
        items.forEach((it,i)=> placeBubble(it, pos(i/items.length*2*Math.PI, R, J)) );
        statusEl.textContent = `Showing ${items.length} comment${items.length===1?"":"s"}.`;
      }catch(e){ console.error(e); statusEl.textContent = "Could not load comments (CSV)."; }
    }

    anchor.addEventListener('targetFound', ()=>{ hintEl.style.display='none'; statusEl.textContent="Target found. Loading commentsâ€¦"; fetchAndRender(); });
    anchor.addEventListener('targetLost',  ()=>{ hintEl.style.display='block'; statusEl.textContent="Waiting for targetâ€¦"; });
  </script>
</body>
</html>
