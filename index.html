<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AR Artwork ‚Äî 2 Fixed + 1 User Bubble</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .a-enter-vr,.a-enter-vr-button,.a-enter-ar,.a-enter-ar-button{display:none!important}

  /* hint + FAB */
  #hint{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;
        padding:6px 10px;border-radius:999px;z-index:6}
  #fab{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);width:68px;height:68px;border-radius:50%;
       background:radial-gradient(120% 120% at 30% 30%, #ffb2d9, #ffcf9a 55%, #b6c8ff);
       box-shadow:0 16px 40px rgba(255,160,200,.45), 0 6px 18px rgba(0,0,0,.35);
       border:1px solid rgba(255,255,255,.35); z-index:6; display:none}

  /* screen-locked bubbles */
  #bubbles{position:fixed;inset:0;pointer-events:none;z-index:5;display:none}
  .bubble{
    position:absolute; max-width:min(90vw,620px); color:#1a1a1a; pointer-events:auto;
    padding:14px 16px 38px; border-radius:22px; backdrop-filter:blur(10px);
    background:linear-gradient(180deg,#fff7f0 0%, #ffe9f6 100%); box-shadow:0 20px 50px rgba(0,0,0,.28);
    border:1px solid rgba(255,255,255,.6)
  }
  .bubble:after{ /* tail */
    content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-16px;
    width:34px; height:18px; background:linear-gradient(180deg,#fff7f0,#ffe9f6);
    clip-path:polygon(0 0,100% 0,50% 100%); filter:drop-shadow(0 8px 12px rgba(0,0,0,.15));
    border-bottom:1px solid rgba(255,255,255,.6); border-left:1px solid rgba(255,255,255,.6); border-right:1px solid rgba(255,255,255,.6);
    border-bottom-left-radius:6px;border-bottom-right-radius:6px;
  }
  .bubble h3{margin:0 0 6px; font-size:16px; font-weight:800; color:#2b232b}
  .bubble p{margin:0; line-height:1.25; color:#2b2b2b}
  .icons{position:absolute; left:14px; bottom:8px; display:flex; gap:14px; opacity:.9}
  .icon{width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center;
        background:#00000010; border:1px solid #00000012; border-radius:999px; cursor:pointer; user-select:none}
  .icon.liked{background:#ff99c51f; border-color:#ff99c560}
  .icon span{font-size:14px}

  /* positions */
  #bubbleTop{top:10%; left:6%}
  #bubbleBottom{bottom:12%; left:50%; transform:translateX(-50%)}
  /* new: user bubble (bottom-right-ish). Adjust if it overlaps on your device */
  #bubbleUser{bottom:28%; right:6%; display:none}

  /* composer (full-screen) */
  #composer{position:fixed;inset:0;display:none;z-index:10;
    background:linear-gradient(140deg,#ffd7bd 15%,#ffc6e0 85%);
    padding:calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 24px)}
  #composer.show{display:block}
  .comp{max-width:560px;margin:0 auto;height:100%;display:flex;flex-direction:column}
  .title{font-weight:800;font-size:22px;text-align:center;color:#2b232b;margin-bottom:12px}
  .pill{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.86);border:1px solid rgba(0,0,0,.08);
        border-radius:18px;padding:10px 12px}
  .pill input{flex:1;border:0;outline:none;background:transparent;font-size:16px;color:#2b232b}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px auto 0;max-width:560px}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06);color:#503d49;cursor:pointer}
  .actions{margin-top:auto;display:flex;gap:10px;justify-content:center}
  .btn{padding:12px 16px;border-radius:14px;border:0;font-weight:700;cursor:pointer}
  .btn.primary{background:#2b232b;color:#fff}
  .btn.secondary{background:#ffffffcc;color:#2b232b}

  /* share-choice modal */
  #shareSheet{position:fixed;inset:0;display:none;z-index:11;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
  #shareSheet.show{display:flex;align-items:center;justify-content:center}
  .sheetCard{
    width:min(560px,92vw); border-radius:22px; background:rgba(255,255,255,.9);
    box-shadow:0 30px 60px rgba(0,0,0,.25); padding:18px; color:#2b232b; position:relative
  }
  .sheetCard h2{margin:0 0 8px; font-size:20px}
  .sheetCard p{margin:0 0 14px; opacity:.85}
  .xbtn{position:absolute; right:12px; top:12px; width:34px; height:34px; border-radius:50%; border:1px solid #00000015; background:#ffffffaa}
  .nameRow{display:flex;gap:8px;align-items:center;background:#ffffff;border:1px solid #00000012;border-radius:14px;padding:10px 12px}
  .nameRow input{flex:1;border:0;outline:none;background:transparent;font-size:16px}
  .sendMini{border:0;background:#2b232b;color:#fff;border-radius:10px;padding:8px 12px;font-weight:700}
  .anonBtn{margin-top:14px;width:100%;border:0;border-radius:18px;padding:14px 16px;background:#d3947b;color:#2b232b;font-weight:800}
</style>
</head>
<body>

<div id="hint">Point your camera at the artwork</div>

<!-- Screen-locked bubbles -->
<div id="bubbles">
  <!-- 1) Artist -->
  <div id="bubbleTop" class="bubble">
    <h3>Zen ‚Äì the artist</h3>
    <p>‚ÄúThis piece explores the interplay of displacement, everyday objects and nostalgic wonder.‚Äù</p>
    <div class="icons">
      <div id="likeTop" class="icon" title="Like"><span>‚ù§Ô∏è</span></div>
      <div class="icon" title="Comment" id="cTop"><span>üí¨</span></div>
      <div class="icon" title="Share" id="sTop"><span>‚ÜóÔ∏é</span></div>
    </div>
  </div>

  <!-- 2) Curator -->
  <div id="bubbleBottom" class="bubble">
    <h3>Curator‚Äôs Note</h3>
    <p>‚ÄúA quiet yet defiant work that turns ordinary retail bags into a field for memory, resilience and becoming.‚Äù</p>
    <div class="icons">
      <div id="likeBottom" class="icon" title="Like"><span>‚ù§Ô∏è</span></div>
      <div class="icon" title="Comment" id="cBottom"><span>üí¨</span></div>
      <div class="icon" title="Share" id="sBottom"><span>‚ÜóÔ∏é</span></div>
    </div>
  </div>

  <!-- 3) User (hidden until first post) -->
  <div id="bubbleUser" class="bubble">
    <h3 id="userTitle">Visitor</h3>
    <p id="userText"></p>
    <div class="icons">
      <div id="likeUser" class="icon" title="Like"><span>‚ù§Ô∏è</span></div>
      <div class="icon" title="Comment" id="cUser"><span>üí¨</span></div>
      <div class="icon" title="Share" id="sUser"><span>‚ÜóÔ∏é</span></div>
    </div>
  </div>
</div>

<!-- FAB -->
<div id="fab" aria-label="Share your thoughts"></div>

<!-- Composer -->
<div id="composer" role="dialog" aria-modal="true">
  <div class="comp">
    <div class="title">What‚Äôs on your mind?</div>
    <div class="pill">
      <input id="compInput" placeholder="It brings me joy because‚Ä¶" maxlength="300"/>
      <button id="postBtn" class="btn primary">Post</button>
    </div>
    <div class="chips" id="chipbar">
      <div class="chip">Happy</div><div class="chip">Grateful</div><div class="chip">Curious</div>
      <div class="chip">Calm</div><div class="chip">Excited</div><div class="chip">Inspired</div>
    </div>
    <div class="actions">
      <button id="closeComp" class="btn secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- Share-choice modal -->
<div id="shareSheet" role="dialog" aria-modal="true">
  <div class="sheetCard">
    <button id="sheetClose" class="xbtn">‚úï</button>
    <h2>How would you like to share?</h2>
    <p>You can add your name or share it anonymous.</p>
    <div class="nameRow">
      <input id="nameInput" placeholder="Add my name"/>
      <button id="sendNamed" class="sendMini">Post ‚û§</button>
    </div>
    <button id="sendAnon" class="anonBtn">Anonymous</button>
  </div>
</div>

<!-- AR scene -->
<a-scene id="scene"
         mindar-image="imageTargetSrc: ./targets%20(7).mind"
         renderer="colorManagement:true, physicallyCorrectLights:false"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true"
         embedded>
  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex: 0"></a-entity>
</a-scene>

<script>
  /* ====== CONFIG ====== */
  const TARGET_PATH = "./targets%20(7).mind";
  document.getElementById("scene").setAttribute("mindar-image", `imageTargetSrc: ${TARGET_PATH}`);

  /* ====== Local state (persist user bubble only) ====== */
  const ART_ID = "art1";
  const k = (n)=>`webar:${ART_ID}:${n}`;
  const load = (n, f)=>{ try{ return JSON.parse(localStorage.getItem(k(n))||JSON.stringify(f)); }catch{ return f; } };
  const save = (n, v)=> localStorage.setItem(k(n), JSON.stringify(v));

  let userData = load("userComment", null); // {text, name, ts}

  const bubbles   = document.getElementById('bubbles');
  const fab       = document.getElementById('fab');
  const hint      = document.getElementById('hint');
  const anchor    = document.getElementById('anchor');
  const bubbleUser= document.getElementById('bubbleUser');
  const userTitle = document.getElementById('userTitle');
  const userText  = document.getElementById('userText');

  // show saved user bubble on load
  if (userData && userData.text){
    userTitle.textContent = userData.name ? userData.name : "Anonymous";
    userText.textContent  = userData.text;
    bubbleUser.style.display = 'block';
  } else {
    bubbleUser.style.display = 'none';
  }

  /* ====== show overlay once on detection, keep it visible after ====== */
  let shown = false;
  anchor.addEventListener('targetFound', ()=>{
    if (shown) return;
    shown = true;
    hint.style.display='none';
    bubbles.style.display='block';
    fab.style.display='block';
  });
  anchor.addEventListener('targetLost', ()=>{/* keep UI visible */});

  /* ====== likes & share for all three ====== */
  function toggleLike(btnId, storeKey){
    const el = document.getElementById(btnId);
    const liked = load(storeKey, false);
    if (liked) el.classList.add('liked');
    el.addEventListener('click', ()=>{
      const now = !load(storeKey, false);
      save(storeKey, now);
      el.classList.toggle('liked', now);
    });
  }
  toggleLike('likeTop','likedTop');
  toggleLike('likeBottom','likedBottom');
  toggleLike('likeUser','likedUser');

  function sharePage(){ const url = location.href;
    if (navigator.share) navigator.share({title:'AR Artwork', url}).catch(()=>{});
    else navigator.clipboard.writeText(url).then(()=>alert('Link copied'));
  }
  document.getElementById('sTop').onclick = sharePage;
  document.getElementById('sBottom').onclick = sharePage;
  document.getElementById('sUser').onclick = sharePage;

  /* ====== composer flow ====== */
  const composer  = document.getElementById('composer');
  const compInput = document.getElementById('compInput');
  const postBtn   = document.getElementById('postBtn');
  const closeComp = document.getElementById('closeComp');
  const chipbar   = document.getElementById('chipbar');

  function openComposer(){ composer.classList.add('show'); compInput.focus(); }
  function closeComposerFn(){ composer.classList.remove('show'); }

  fab.onclick = openComposer;
  document.getElementById('cTop').onclick = openComposer;
  document.getElementById('cBottom').onclick = openComposer;
  document.getElementById('cUser').onclick = openComposer;
  closeComp.onclick = closeComposerFn;

  chipbar.onclick = (e)=>{ if(e.target.classList.contains('chip')) {
    const t=e.target.textContent.trim();
    compInput.value = compInput.value ? (compInput.value + ' ' + t) : t;
    compInput.focus();
  }};

  /* ====== share-choice modal ====== */
  const sheet      = document.getElementById('shareSheet');
  const sheetClose = document.getElementById('sheetClose');
  const nameInput  = document.getElementById('nameInput');
  const sendNamed  = document.getElementById('sendNamed');
  const sendAnon   = document.getElementById('sendAnon');

  function openSheet(){ sheet.classList.add('show'); nameInput.value=''; nameInput.focus(); }
  function closeSheet(){ sheet.classList.remove('show'); }

  postBtn.onclick = ()=>{
    const t = (compInput.value||"").trim();
    if(!t){ compInput.focus(); return; }
    openSheet();
  };
  sheetClose.onclick = closeSheet;

  function finishPost(name){
    const text = (compInput.value||"").trim(); if(!text) return;
    userData = { text, name: (name||"").trim() || null, ts: Date.now() };
    save("userComment", userData);

    // show/update the 3rd bubble (do not replace the curator/artist ones)
    userTitle.textContent = userData.name ? userData.name : "Anonymous";
    userText.textContent  = userData.text;
    bubbleUser.style.display = 'block';

    closeSheet();
    closeComposerFn();
  }
  sendNamed.onclick = ()=> finishPost(nameInput.value);
  nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); finishPost(nameInput.value); }});
  sendAnon.onclick  = ()=> finishPost(null);
</script>
</body>
</html>
