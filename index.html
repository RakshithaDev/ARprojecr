<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AR Artwork — 2 Bubbles + Freeze</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .a-enter-vr,.a-enter-vr-button,.a-enter-ar,.a-enter-ar-button{display:none!important}
  #hint{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);
        color:#fff;padding:6px 10px;border-radius:999px;z-index:6}
  #fab{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);width:68px;height:68px;border-radius:50%;
       background:radial-gradient(120% 120% at 30% 30%, #ffb2d9, #ffcf9a 55%, #b6c8ff);
       box-shadow:0 16px 40px rgba(255,160,200,.45), 0 6px 18px rgba(0,0,0,.35);
       border:1px solid rgba(255,255,255,.35); z-index:5; display:none}
  #toast{position:fixed;left:50%;bottom:110px;transform:translateX(-50%) translateY(18px);
         background:rgba(15,18,26,.92);color:#fff;border:1px solid #263044;padding:10px 14px;border-radius:12px;
         opacity:0;transition:.25s;z-index:6}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* full-screen composer (kept) */
  #composer{position:fixed; inset:0; z-index:10; display:none;
    background:linear-gradient(140deg,#ffd7bd 15%,#ffc6e0 85%);
    padding:env(safe-area-inset-top) 16px calc(20px + env(safe-area-inset-bottom)) 16px;}
  #composer.show{display:block; animation:fadeIn .18s ease}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .comp-wrap{max-width:560px; margin:0 auto; height:100%; display:flex; flex-direction:column}
  .comp-head{padding:18px 6px 8px; text-align:center; font-weight:700; font-size:22px; color:#2b232b}
  .pill{display:flex; align-items:center; gap:8px; background:rgba(255,255,255,.85); border:1px solid rgba(0,0,0,.08);
        box-shadow:0 6px 18px rgba(0,0,0,.08) inset; border-radius:18px; padding:10px 12px; margin:10px 0;}
  .pill input{flex:1; border:0; outline:none; background:transparent; font-size:15px; color:#2b232b}
  .iconbtn{border:0;background:transparent;font-size:18px;line-height:1;opacity:.75}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.08);color:#503d49;font-size:12px;border:1px solid rgba(0,0,0,.06)}
  .chip.touch{cursor:pointer}
  .actions{margin-top:auto; display:flex; gap:10px; justify-content:center; padding:12px 0}
  .btn{padding:12px 16px;border-radius:14px;border:0;cursor:pointer;font-weight:700;background:#2b232b;color:#fff; box-shadow:0 8px 18px rgba(0,0,0,.15)}
  .btn.secondary{background:#ffffffaa; color:#2b232b}
</style>
</head>
<body>

<div id="hint">Point your camera at the artwork</div>
<div id="fab" aria-label="Share your thoughts"></div>
<div id="toast">Saved</div>

<!-- FULL-SCREEN COMPOSER -->
<div id="composer" role="dialog" aria-modal="true">
  <div class="comp-wrap">
    <div class="comp-head">What’s on your mind?</div>
    <div class="pill">
      <input id="compInput" placeholder="What do you feel?" maxlength="300" />
      <button class="iconbtn" title="send" id="compSend">➤</button>
    </div>
    <div class="chips" id="chipbar">
      <div class="chip touch">Happy</div><div class="chip touch">Grateful</div>
      <div class="chip touch">Curious</div><div class="chip touch">Calm</div>
      <div class="chip touch">Excited</div><div class="chip touch">Inspired</div>
    </div>
    <div class="actions">
      <button class="btn secondary" id="compClose">Cancel</button>
      <button class="btn" id="compPost">Post</button>
    </div>
  </div>
</div>

<!-- AR scene -->
<a-scene mindar-image="imageTargetSrc: ./targets%20(6).mind"
         renderer="colorManagement:true, physicallyCorrectLights:false"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true"
         embedded id="scene">
  <!-- cursor so taps on icons/bubbles are clickable if you add them later -->
  <a-camera look-controls="enabled:false">
    <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
  </a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex: 0"></a-entity>
</a-scene>

<script>
  /* ---------------- config ---------------- */
  const MAX_BUBBLES = 2;            // <= always show at most two
  const FREEZE_AFTER_MS = 600;      // wait a moment, then freeze tracking
  const ART_ID="art1";

  /* ---------- light, readable card ---------- */
  const cache={};
  function bubblePNG(w=900,h=380){
    const key=w+"|"+h; if(cache[key]) return cache[key];
    const cv=document.createElement("canvas"); cv.width=w; cv.height=h; const ctx=cv.getContext("2d");
    ctx.shadowColor="rgba(0,0,0,.28)"; ctx.shadowBlur=36; ctx.shadowOffsetY=18;
    const x=20,y=20,ww=w-40,hh=300,r=38;
    ctx.fillStyle="#ffffff"; ctx.globalAlpha=.93;
    ctx.beginPath();
    ctx.moveTo(x+r,y); ctx.arcTo(x+ww,y,x+ww,y+r,r);
    ctx.arcTo(x+ww,y+hh,x+ww-r,y+hh,r); ctx.arcTo(x,y+hh,x,y+hh-r,r);
    ctx.arcTo(x,y,x+r,y,r); ctx.closePath(); ctx.fill();
    const g=ctx.createLinearGradient(0,y,0,y+hh); g.addColorStop(0,"#fff3ea"); g.addColorStop(1,"#ffe9f6");
    ctx.globalAlpha=.4; ctx.fillStyle=g; ctx.fill(); ctx.globalAlpha=1;
    ctx.fillStyle="#ffffffee";
    ctx.beginPath(); ctx.moveTo(w/2-44,y+hh); ctx.lineTo(w/2+44,y+hh); ctx.lineTo(w/2,y+hh+42); ctx.closePath(); ctx.fill();
    return cache[key]=cv.toDataURL("image/png");
  }

  /* ---------- static bubbles (exactly 2) ---------- */
  const POS_TOP   ={x:-0.22, y: 0.25, z:0.02}, SIZE_TOP   ={w:0.98,h:0.42};
  const POS_BOTTOM={x: 0.00, y:-0.28, z:0.02}, SIZE_BOTTOM={w:1.12,h:0.46};

  const STATIC_BUBBLES = [
    { id:"static-1", title:"Zen – the artist",
      text:`"This piece explores the interplay of displacement, everyday objects and nostalgic wonder."`,
      pos:POS_TOP,   size:SIZE_TOP },
    { id:"static-2", title:"Curator’s Note",
      text:`"A quiet yet defiant work that turns ordinary retail bags into a field for memory, resilience and becoming."`,
      pos:POS_BOTTOM,size:SIZE_BOTTOM }
  ];

  /* ---------- local storage for one extra visitor bubble (optional) ---------- */
  const K=(n)=>`webar:${ART_ID}:${n}`;
  const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(K(k))||JSON.stringify(f));}catch{return f;}};
  const save=(k,v)=>localStorage.setItem(K(k),JSON.stringify(v));
  let dynamic = load('comments', []); // [{id,text,ts}]

  /* ---------- build a bubble entity ---------- */
  const anchorEl=document.getElementById('anchor');
  function addBubble(spec){
    const g=document.createElement("a-entity"); g.dataset.bid = spec.id;
    g.setAttribute("position",`${spec.pos.x} ${spec.pos.y} ${spec.pos.z}`);

    const bg=document.createElement("a-image");
    bg.setAttribute("src",bubblePNG());
    bg.setAttribute("width",spec.size.w); bg.setAttribute("height",spec.size.h);
    bg.setAttribute("shader","flat"); bg.setAttribute("material","transparent:true; alphaTest:0.01; side:double");
    g.appendChild(bg);

    const title=document.createElement("a-text");
    title.setAttribute("value",spec.title||"");
    title.setAttribute("color","#222"); title.setAttribute("align","left"); title.setAttribute("width",1.8);
    title.setAttribute("position",`${-spec.size.w/2+0.12} ${spec.size.h/2-0.12} 0.03`); g.appendChild(title);

    const body=document.createElement("a-text");
    body.setAttribute("value",spec.text||"");
    body.setAttribute("color","#1f1f1f"); body.setAttribute("align","left");
    body.setAttribute("wrap-count",34); body.setAttribute("width",1.8);
    body.setAttribute("position",`${-spec.size.w/2+0.12} ${spec.size.h/2-0.30} 0.03`); g.appendChild(body);

    anchorEl.appendChild(g);
    return g;
  }

  /* ---------- render: always at most 2 ---------- */
  let rendered=[];
  function clearRendered(){ rendered.forEach(e=>e.remove()); rendered=[]; }
  function renderTwo(){
    clearRendered();
    // pick 2: static first, then latest visitor if present
    const chosen = STATIC_BUBBLES.slice(0,2);
    if (dynamic[0]) {
      // place visitor bubble at bottom, push curator up
      chosen[1] = { id: dynamic[0].id, title: "Visitor",
                    text: dynamic[0].text, pos: POS_BOTTOM, size: SIZE_BOTTOM };
    }
    chosen.slice(0,MAX_BUBBLES).forEach(spec=> rendered.push(addBubble(spec)));
  }

  /* ---------- composer (adds/keeps max 1 dynamic) ---------- */
  const composer=document.getElementById('composer');
  const compInput=document.getElementById('compInput');
  const compPost=document.getElementById('compPost');
  const compSend=document.getElementById('compSend');
  const compClose=document.getElementById('compClose');
  const chipbar=document.getElementById('chipbar');
  const fab=document.getElementById('fab');
  const hint=document.getElementById('hint');
  const toast=document.getElementById('toast');

  function showToast(m){ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1400); }
  function openComposer(){ composer.classList.add('show'); compInput.focus(); }
  function closeComposer(){ composer.classList.remove('show'); }

  fab.addEventListener('click', openComposer);
  compClose.addEventListener('click', closeComposer);
  compSend.addEventListener('click', ()=>compPost.click());

  chipbar.addEventListener('click', (e)=>{
    if(!e.target.classList.contains('chip')) return;
    const t=e.target.textContent.trim();
    compInput.value = compInput.value ? (compInput.value + ' ' + t) : t;
    compInput.focus();
  });

  compPost.addEventListener('click', ()=>{
    const text=(compInput.value||"").trim(); if(!text){ showToast('Type your thought first'); return; }
    compInput.value="";
    dynamic = [{id:"dyn-"+Date.now(), text, ts:Date.now()}]; // keep only the latest one
    save('comments', dynamic);
    renderTwo(); closeComposer(); showToast('Saved on this device');
  });

  /* ---------- freeze tracking after first lock ---------- */
  let frozen=false;
  function freezeTracking(){
    if (frozen) return;
    frozen=true;
    // clone anchor world transform to a sibling holder, move bubbles there, remove tracking component
    const THREE = AFRAME.THREE;
    const holder=document.createElement('a-entity'); holder.id='locked-holder';
    anchorEl.sceneEl.appendChild(holder);
    holder.object3D.matrixAutoUpdate=false;
    holder.object3D.matrix.copy(anchorEl.object3D.matrixWorld);
    // move rendered nodes
    rendered.forEach(n=> holder.appendChild(n));
    // prevent further anchor updates (but keep camera video running)
    try{ anchorEl.removeAttribute('mindar-image-target'); }catch{}
  }

  /* ---------- AR events ---------- */
  let seeded=false;
  anchorEl.addEventListener('targetFound', ()=>{
    hint.style.display='none'; fab.style.display='block';
    if (!seeded){ seeded=true; renderTwo(); setTimeout(freezeTracking, FREEZE_AFTER_MS); }
  });
  anchorEl.addEventListener('targetLost',  ()=>{
    // we ignore targetLost after freeze, so bubbles stay stable on screen
    if (!frozen){ hint.style.display='block'; fab.style.display='none'; }
  });
</script>
</body>
</html>
