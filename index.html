<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AR Artwork ‚Äî 4 Bubbles + Draggable + AI Suggestions</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .a-enter-vr,.a-enter-vr-button,.a-enter-ar,.a-enter-ar-button{display:none!important}

  /* hint + FAB */
  #hint{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;
        padding:6px 10px;border-radius:999px;z-index:7}
  #fab{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);width:68px;height:68px;border-radius:50%;
       background:radial-gradient(120% 120% at 30% 30%, #ffb2d9, #ffcf9a 55%, #b6c8ff);
       box-shadow:0 16px 40px rgba(255,160,200,.45), 0 6px 18px rgba(0,0,0,.35);
       border:1px solid rgba(255,255,255,.35); z-index:7; display:none; cursor:pointer}

  /* Bubbles layer */
  #bubbles{position:fixed;inset:0;pointer-events:none;z-index:6;display:none}
  .bubble{
    position:absolute; max-width:min(44vw,560px); color:#1a1a1a; pointer-events:auto;
    padding:14px 16px 38px; border-radius:22px; backdrop-filter:blur(10px);
    background:linear-gradient(180deg,#fff7f0 0%, #ffe9f6 100%); box-shadow:0 20px 50px rgba(0,0,0,.28);
    border:1px solid rgba(255,255,255,.6); touch-action:none; /* for draggable */
    user-select:none;
  }
  .bubble:after{
    content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-16px;
    width:34px; height:18px; background:linear-gradient(180deg,#fff7f0,#ffe9f6);
    clip-path:polygon(0 0,100% 0,50% 100%); filter:drop-shadow(0 8px 12px rgba(0,0,0,.15));
    border-bottom:1px solid rgba(255,255,255,.6); border-left:1px solid rgba(255,255,255,.6); border-right:1px solid rgba(255,255,255,.6);
    border-bottom-left-radius:6px;border-bottom-right-radius:6px;
  }
  .bubble h3{margin:0 0 6px; font-size:16px; font-weight:800; color:#2b232b}
  .bubble p{margin:0; line-height:1.25; color:#2b2b2b}
  .icons{position:absolute; left:14px; bottom:8px; display:flex; gap:14px; opacity:.95}
  .icon{width:26px; height:26px; display:inline-flex; align-items:center; justify-content:center;
        background:#00000010; border:1px solid #00000012; border-radius:999px; cursor:pointer; user-select:none; transition:.15s}
  .icon span{font-size:14px}
  /* Like turns red */
  .icon.like.liked{background:#ff2b5f; border-color:#ff2b5f; color:#fff}
  .icon.like.liked span{filter:brightness(4)}
  .icon:active{transform:scale(0.97)}

  /* 4 positions */
  #b1{top:10%; left:6%}
  #b2{top:10%; right:6%}
  #b3{bottom:14%; left:8%}
  #b4{bottom:14%; right:8%}

  /* Composer sheet */
  #composer{position:fixed;inset:0;display:none;z-index:10;
    background:linear-gradient(140deg,#ffd7bd 15%,#ffc6e0 85%);
    padding:calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 24px)}
  #composer.show{display:block}
  .comp{max-width:560px;margin:0 auto;height:100%;display:flex;flex-direction:column}
  .title{font-weight:800;font-size:22px;text-align:center;color:#2b232b;margin-bottom:12px}
  .pill{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.9);border:1px solid rgba(0,0,0,.08);
        border-radius:18px;padding:10px 12px}
  .pill input{flex:1;border:0;outline:none;background:transparent;font-size:16px;color:#2b232b}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px auto 0;max-width:560px}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06);color:#503d49;cursor:pointer}

  /* AI suggestions row */
  #aiRow{margin:12px auto 0;max-width:560px;display:flex;gap:8px;flex-wrap:wrap}
  .sugg{padding:8px 10px;border-radius:12px;border:1px solid #00000012;background:#fff;cursor:pointer}
  #regen{padding:8px 10px;border-radius:12px;border:1px solid #00000022;background:#111a22;color:#fff;cursor:pointer}

  .actions{margin-top:auto;display:flex;gap:10px;justify-content:center}
  .btn{padding:12px 16px;border-radius:14px;border:0;font-weight:700;cursor:pointer}
  .btn.primary{background:#2b232b;color:#fff}
  .btn.secondary{background:#ffffffcc;color:#2b232b}

  /* Thread overlay (draggable cards) */
  #thread{position:fixed;left:0;right:0;bottom:96px;z-index:8;display:none;pointer-events:auto}
  .threadWrap{max-width:680px;margin:0 auto;padding:0 12px;display:flex;flex-direction:column;gap:12px}
  .tCard{
    position:relative;
    border-radius:28px;
    background:linear-gradient(180deg,#eaa38c 0%, #c17567 100%);
    color:#fff; padding:14px 18px; box-shadow:0 22px 50px rgba(0,0,0,.35);
    border:1px solid #ffffff33; display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    touch-action:none; user-select:none; /* for drag */
  }
  .tMeta{min-width:140px;font-weight:700}
  .tMeta small{display:block;opacity:.85;font-weight:600}
  .tText{flex:1;min-width:180px}
  .tActions{display:flex;gap:10px;margin-left:auto}
  .tBtnLite{background:#ffffff22;border:1px solid #ffffff44;border-radius:12px;padding:8px 10px;cursor:pointer}
  .tBtnLite.hot{background:#ff2b5f;border-color:#ff2b5f;color:#fff}
  .tBar{display:flex;justify-content:flex-end;gap:10px;margin:6px auto 0;max-width:680px;padding:0 12px}
  .tBtn{background:#111a22;color:#fff;border:1px solid #2a3342;border-radius:12px;padding:8px 12px;cursor:pointer}
</style>
</head>
<body>

<div id="hint">Point your camera at the artwork</div>

<!-- 4 comment bubbles (rendered from THREAD) -->
<div id="bubbles">
  <div id="b1" class="bubble"><h3></h3><p></p><div class="icons">
    <div class="icon like"><span>‚ù§Ô∏è</span></div>
    <div class="icon cmts"><span>üí¨</span></div>
    <div class="icon share"><span>‚ÜóÔ∏é</span></div>
  </div></div>

  <div id="b2" class="bubble"><h3></h3><p></p><div class="icons">
    <div class="icon like"><span>‚ù§Ô∏è</span></div>
    <div class="icon cmts"><span>üí¨</span></div>
    <div class="icon share"><span>‚ÜóÔ∏é</span></div>
  </div></div>

  <div id="b3" class="bubble"><h3></h3><p></p><div class="icons">
    <div class="icon like"><span>‚ù§Ô∏è</span></div>
    <div class="icon cmts"><span>üí¨</span></div>
    <div class="icon share"><span>‚ÜóÔ∏é</span></div>
  </div></div>

  <div id="b4" class="bubble"><h3></h3><p></p><div class="icons">
    <div class="icon like"><span>‚ù§Ô∏è</span></div>
    <div class="icon cmts"><span>üí¨</span></div>
    <div class="icon share"><span>‚ÜóÔ∏é</span></div>
  </div></div>
</div>

<!-- FAB to open composer -->
<div id="fab" aria-label="Share your thoughts" title="Add a comment"></div>

<!-- Thread overlay -->
<div id="thread">
  <div class="threadWrap" id="threadList"></div>
  <div class="tBar">
    <button id="threadNext" class="tBtn">Next ‚Üª</button>
    <button id="threadClose" class="tBtn">Close ‚úï</button>
  </div>
</div>

<!-- Composer -->
<div id="composer" role="dialog" aria-modal="true">
  <div class="comp">
    <div class="title">What‚Äôs on your mind?</div>
    <div class="pill">
      <input id="compInput" placeholder="Add your thought‚Ä¶" maxlength="300"/>
      <button id="sendBtn" class="btn primary">Post</button>
    </div>
    <div class="chips" id="chipbar">
      <div class="chip">Happy</div><div class="chip">Grateful</div><div class="chip">Curious</div>
      <div class="chip">Calm</div><div class="chip">Excited</div><div class="chip">Inspired</div>
    </div>
    <!-- AI suggestions -->
    <div id="aiRow">
      <button id="regen">‚ú® Suggest</button>
      <span id="suggs"></span>
    </div>
    <div class="actions">
      <button id="closeComp" class="btn secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- Share Options (name / anonymous) -->
<div id="shareModal" aria-modal="true" role="dialog">
  <div class="sheet">
    <div class="sheetHead">
      <strong>How would you like to share?</strong>
      <button id="shareClose" class="xBtn">‚úï</button>
    </div>
    <div class="sheetBody">
      <label for="shareName" style="font-weight:600;">You can add your name or share it anonymously.</label>
      <input id="shareName" class="nameInput" placeholder="Add my name" />
      <div class="sheetActions">
        <button id="btnAnon" class="sBtn sGhost">Anonymous</button>
        <button id="btnWithName" class="sBtn sPrimary">Post</button>
      </div>
    </div>
  </div>
</div>

<!-- AR scene -->
<a-scene id="scene"
         mindar-image="imageTargetSrc: ./targets%20(10).mind"
         renderer="colorManagement:true, physicallyCorrectLights:false"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true"
         embedded>
  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex: 0"></a-entity>
</a-scene>

<script>
/* ========= Config & storage ========= */
const ART_ID = "art1";
const k = (n)=>`webar:${ART_ID}:${n}`;
const load = (n, f)=>{ try{ return JSON.parse(localStorage.getItem(k(n))||JSON.stringify(f)); }catch{ return f; } };
const save = (n, v)=> localStorage.setItem(k(n), JSON.stringify(v));
const DEBUG = /[?&]debug=1/.test(location.search);

/* ========= Data model ========= */
let THREAD = load("threadData", []);
let LIKESET = new Set(load("likes", [])); // store liked ids
function seedIfNeeded(){
  if (!Array.isArray(THREAD) || THREAD.length === 0){
    const seed = [
      { id: uid(), user:"lucyjean333", age:"11h", text:"Love this!!", likes:5 },
      { id: uid(), user:"talk_tour",   age:"2d",  text:"Love your content!", likes:8 },
      { id: uid(), user:"gallery_go",  age:"3d",  text:"The composition is beautiful.", likes:2 },
      { id: uid(), user:"art_student", age:"5d",  text:"This spoke to me today.", likes:4 }
    ];
    THREAD = seed;
    persistThread();
  } else {
    THREAD.forEach(it=>{ if(!it.id) it.id = uid(); });
    persistThread();
  }
}
function persistThread(){ save("threadData", THREAD); }
function saveLikes(){ save("likes", Array.from(LIKESET)); }
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
seedIfNeeded();

/* ========= Deep link helper ========= */
function makePermalink(item){
  const payload = { id:item.id, user:item.user||"Anonymous", text:item.text||"", ts:Date.now() };
  const b64 = btoa(JSON.stringify(payload));
  const url = new URL(location.href);
  url.searchParams.set('c', encodeURIComponent(b64));
  return url.toString();
}

/* ========= UI refs ========= */
const hint = document.getElementById('hint');
const bubbles = document.getElementById('bubbles');
const fab = document.getElementById('fab');
const anchor = document.getElementById('anchor');

const bEls = [
  document.getElementById('b1'),
  document.getElementById('b2'),
  document.getElementById('b3'),
  document.getElementById('b4')
];

let shown = false;
function showOverlaysNow(){
  if (shown) return;
  shown = true;
  hint.style.display = 'none';
  bubbles.style.display = 'block';
  fab.style.display = 'block';
}
anchor.addEventListener('targetFound', showOverlaysNow);
if (DEBUG){ showOverlaysNow(); }

/* ========= Render 4 bubbles ========= */
function renderBubbles(){
  const latest4 = THREAD.slice(0,4);
  while(latest4.length < 4) latest4.push({id:uid(), user:"Anonymous", age:"", text:"", likes:0});
  latest4.forEach((item, idx)=>{
    const el = bEls[idx];
    el.querySelector('h3').textContent = item.user || "Anonymous";
    el.querySelector('p').textContent  = '‚Äú' + (item.text||'') + '‚Äù';
    el.dataset.itemId = item.id;

    // Like (toggle and red)
    const likeBtn = el.querySelector('.like');
    likeBtn.classList.toggle('liked', LIKESET.has(item.id));
    likeBtn.onclick = ()=>{
      const i = THREAD.findIndex(x=>x.id===item.id);
      const liked = LIKESET.has(item.id);
      if (i>=0){
        if (liked){ THREAD[i].likes = Math.max(0, (THREAD[i].likes||0)-1); LIKESET.delete(item.id); }
        else { THREAD[i].likes = (THREAD[i].likes||0)+1; LIKESET.add(item.id); }
        persistThread(); saveLikes();
      }
      likeBtn.classList.toggle('liked');
    };

    // Comments open loop at this comment
    const cmtsBtn = el.querySelector('.cmts');
    cmtsBtn.onclick = ()=>{
      const i = THREAD.findIndex(x=>x.id===item.id);
      openThreadAt(i>=0 ? i : 0);
    };

    // Share screenshot with this comment
    const shareBtn = el.querySelector('.share');
    shareBtn.onclick = ()=>{
      const i = THREAD.findIndex(x=>x.id===item.id);
      const real = i>=0 ? THREAD[i] : item;
      const link = makePermalink(real);
      captureAndShare(real, link);
    };

    // Make bubble draggable
    makeDraggable(el);
  });
}
renderBubbles();

/* ========= Draggable helpers ========= */
function makeDraggable(el){
  let sx=0, sy=0, ox=0, oy=0, dragging=false;
  const rect = ()=> el.getBoundingClientRect();

  const onDown = (ev)=>{
    dragging=true;
    const p = ev.touches ? ev.touches[0] : ev;
    const r = rect();
    sx = p.clientX; sy = p.clientY;
    ox = r.left; oy = r.top;
    ev.preventDefault();
  };
  const onMove = (ev)=>{
    if (!dragging) return;
    const p = ev.touches ? ev.touches[0] : ev;
    const dx = p.clientX - sx;
    const dy = p.clientY - sy;
    const left = Math.max(8, Math.min(window.innerWidth - rW(), ox + dx));
    const top  = Math.max(8, Math.min(window.innerHeight - rH(), oy + dy));
    el.style.left = left + "px";
    el.style.top  = top  + "px";
    el.style.right = "auto"; el.style.bottom = "auto";
  };
  const onUp = ()=> dragging=false;
  const rW = ()=> rect().width;
  const rH = ()=> rect().height;

  el.addEventListener('pointerdown', onDown);
  window.addEventListener('pointermove', onMove);
  window.addEventListener('pointerup', onUp);

  // for touch (Safari)
  el.addEventListener('touchstart', onDown, {passive:false});
  window.addEventListener('touchmove', onMove, {passive:false});
  window.addEventListener('touchend', onUp);
}

/* ========= Composer + AI suggestions ========= */
const composer = document.getElementById('composer');
const compInput = document.getElementById('compInput');
const sendBtn = document.getElementById('sendBtn');
const closeComp = document.getElementById('closeComp');
const chipbar = document.getElementById('chipbar');
const regen = document.getElementById('regen');
const suggsWrap = document.getElementById('suggs');

function openComposer(){ composer.classList.add('show'); compInput.focus(); updateAISuggestions(); }
function closeComposer(){ composer.classList.remove('show'); }
fab.onclick = openComposer;
closeComp.onclick = closeComposer;
chipbar.onclick = (e)=>{ if(e.target.classList.contains('chip')) {
  const t = e.target.textContent.trim();
  compInput.value = compInput.value ? (compInput.value + ' ' + t) : t;
  compInput.focus(); updateAISuggestions();
}};

compInput.addEventListener('input', updateAISuggestions);
regen.addEventListener('click', ()=> updateAISuggestions(true));

function updateAISuggestions(forceRefresh=false){
  // simple on-device ‚ÄúAI‚Äù: matches mood/keywords and proposes 3 concise completions
  const t = (compInput.value||"").toLowerCase().trim();
  const mood = detectMood(t);
  const base = t ? capitalize(t) : "";

  const pools = {
    happy: [
      "This made my day!",
      "Such a bright, joyful piece.",
      "Smiles guaranteed every time."
    ],
    grateful: [
      "Grateful for the story behind this.",
      "Thank you for sharing this work.",
      "Feels like a warm hug."
    ],
    curious: [
      "I‚Äôm curious about the materials used.",
      "How was this composed?",
      "I want to learn more about the process."
    ],
    calm: [
      "Soothing and grounding.",
      "I feel at peace looking at this.",
      "Quiet, but powerful."
    ],
    excited: [
      "I can‚Äôt stop looking at it!",
      "Electrifying energy.",
      "I‚Äôm buzzing after seeing this."
    ],
    inspired: [
      "This inspires me to create.",
      "I‚Äôm taking this as a prompt.",
      "Motivated to try something new."
    ],
    neutral: [
      "This really resonates with me.",
      "It brings back memories.",
      "I connected with this instantly."
    ]
  };

  let cands = pools[mood].slice(0);
  // blend user text seed
  if (base) cands = cands.map(s => base + (base.endsWith('.') ? ' ' : '. ') + s);

  // shuffle a bit
  if (forceRefresh) cands.sort(()=>Math.random()-0.5);

  // ensure 3
  const more = pools.neutral.filter(x=>!cands.includes(x));
  while (cands.length<3 && more.length) cands.push(more.shift());

  // render
  suggsWrap.innerHTML = "";
  cands.slice(0,3).forEach(s=>{
    const b = document.createElement('button');
    b.className = 'sugg';
    b.textContent = s;
    b.onclick = ()=>{ compInput.value = s; compInput.focus(); };
    suggsWrap.appendChild(b);
  });
}

function detectMood(t){
  if (/grateful|thanks|thankful|gratitude/.test(t)) return "grateful";
  if (/curious|wonder|how|why/.test(t)) return "curious";
  if (/calm|peace|soothing|quiet/.test(t)) return "calm";
  if (/excited|wow|amazing|love|stunning|incredible/.test(t)) return "excited";
  if (/inspire|motivated|prompt/.test(t)) return "inspired";
  if (/happy|joy|smile/.test(t)) return "happy";
  return "neutral";
}
function capitalize(s){ return s ? s[0].toUpperCase()+s.slice(1) : s; }

// Post opens Share Options
let pendingText = "";
sendBtn.onclick = ()=>{
  const t = (compInput.value||"").trim();
  if(!t) return;
  pendingText = t;
  document.getElementById('shareName').value = "";
  openShareModal();
};

/* ========= Share Options ========= */
const shareModal = document.getElementById('shareModal');
const shareClose = document.getElementById('shareClose');
const btnAnon = document.getElementById('btnAnon');
const btnWithName = document.getElementById('btnWithName');
const shareName = document.getElementById('shareName');

function openShareModal(){ shareModal.classList.add('show'); }
function closeShareModal(){ shareModal.classList.remove('show'); }
shareClose.onclick = closeShareModal;

function finalizePost(nameOrNull){
  const newItem = { id:uid(), user:(nameOrNull||"Anonymous"), age:"now", text: pendingText, likes:0 };
  THREAD.unshift(newItem);
  persistThread();
  compInput.value = ""; pendingText = "";
  closeShareModal(); closeComposer();
  renderBubbles();          // refresh 4 bubbles
  openThreadAt(0);          // open loop starting from the new comment
}
btnAnon.onclick = ()=> finalizePost(null);
btnWithName.onclick = ()=> finalizePost( (shareName.value||"").trim() || null );

/* ========= Thread (draggable items) ========= */
const thread = document.getElementById('thread');
const threadList = document.getElementById('threadList');
const threadNext = document.getElementById('threadNext');
const threadClose = document.getElementById('threadClose');
let tIndex = 0;

function renderThread(){
  threadList.innerHTML = "";
  const N = Math.min(3, THREAD.length);
  for (let i=0;i<N;i++){
    const idx = (tIndex + i) % THREAD.length;
    const item = THREAD[idx];
    const card = document.createElement('div');
    card.className = "tCard";
    card.innerHTML = `
      <div class="tMeta">@${escapeHtml(item.user)}<small>${escapeHtml(item.age)}</small></div>
      <div class="tText">${escapeHtml(item.text)}</div>
      <div class="tActions">
        <button class="tBtnLite tLike ${LIKESET.has(item.id)?'hot':''}" data-i="${idx}">üëç <span>${item.likes||0}</span></button>
        <button class="tBtnLite tShare" data-i="${idx}">‚ÜóÔ∏é Share</button>
      </div>`;
    threadList.appendChild(card);
    makeDraggable(card); // draggable thread card
  }

  // like toggle (red)
  threadList.querySelectorAll('.tLike').forEach(btn=>{
    btn.onclick = (e)=>{
      const i = Number(e.currentTarget.dataset.i);
      const item = THREAD[i];
      const liked = LIKESET.has(item.id);
      if (liked){ item.likes = Math.max(0,(item.likes||0)-1); LIKESET.delete(item.id); }
      else { item.likes = (item.likes||0)+1; LIKESET.add(item.id); }
      persistThread(); saveLikes();
      btn.classList.toggle('hot');
      btn.querySelector('span').textContent = item.likes;
    };
  });

  // share (screenshot + deep-link)
  threadList.querySelectorAll('.tShare').forEach(btn=>{
    btn.onclick = (e)=>{
      const i = Number(e.currentTarget.dataset.i);
      const item = THREAD[i];
      const link = makePermalink(item);
      captureAndShare(item, link);
    };
  });
}

function openThread(){ renderThread(); thread.style.display='block'; }
function openThreadAt(startIdx){
  if (!THREAD.length) return;
  tIndex = ((startIdx%THREAD.length)+THREAD.length)%THREAD.length;
  openThread();
}
function closeThread(){ thread.style.display='none'; }
threadNext.onclick = ()=>{ if (THREAD.length){ tIndex = (tIndex + 3) % THREAD.length; renderThread(); } };
threadClose.onclick = closeThread;

/* ========= Screenshot + share ========= */
async function captureAndShare(item, urlForShare){
  try{
    const glCanvas = document.querySelector('canvas.a-canvas');
    const baseW = glCanvas ? glCanvas.width : Math.min(1080, window.innerWidth*2);
    const baseH = glCanvas ? glCanvas.height: Math.min(1920, window.innerHeight*2);

    const out = document.createElement('canvas');
    out.width = baseW; out.height = baseH;
    const ctx = out.getContext('2d');

    // draw AR scene or gradient
    if (glCanvas){ ctx.drawImage(glCanvas, 0, 0, baseW, baseH); }
    else { const g=ctx.createLinearGradient(0,0,0,baseH); g.addColorStop(0,'#ffe1c9'); g.addColorStop(1,'#f7d3e9'); ctx.fillStyle=g; ctx.fillRect(0,0,baseW,baseH); }

    // comment card
    const margin = Math.round(baseW*0.05);
    const boxW = baseW - margin*2;
    const maxBoxH = Math.round(baseH*0.35);
    const boxX = margin;
    const boxY = baseH - maxBoxH - margin;

    roundedRect(ctx, boxX, boxY, boxW, maxBoxH, Math.round(24*baseW/1080), 'rgba(0,0,0,0.55)');
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    roundedRect(ctx, boxX+6, boxY+6, boxW-12, maxBoxH-12, Math.round(22*baseW/1080), ctx.fillStyle);

    const pad = Math.round(24*baseW/1080);
    ctx.fillStyle = '#2b232b';
    ctx.font = `${Math.round(36*baseW/1080)}px system-ui, -apple-system, Segoe UI, Roboto`;
    ctx.textBaseline = 'top';

    const title = '@' + (item.user || 'Anonymous');
    ctx.fillText(title, boxX+pad, boxY+pad);

    const textY = boxY + pad + Math.round(44*baseW/1080);
    ctx.font = `${Math.round(34*baseW/1080)}px system-ui, -apple-system, Segoe UI, Roboto`;
    drawWrappedText(ctx, '‚Äú' + (item.text||'') + '‚Äù', boxX+pad, textY, boxW - pad*2, Math.round(44*baseW/1080));

    out.toBlob(async (blob)=>{
      const file = new File([blob], 'ar-comment.png', {type:'image/png'});
      if (navigator.canShare && navigator.canShare({files:[file]})){
        try { await navigator.share({ files:[file], title:'AR Comment', text:item.text, url:urlForShare }); } catch(e){}
      } else if (navigator.share){
        try { await navigator.share({ title:'AR Comment', text:item.text, url:urlForShare }); } catch(e){}
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ar-comment.png'; document.body.appendChild(a); a.click(); a.remove();
      } else {
        try { await navigator.clipboard.writeText(urlForShare); alert('Link copied. Image will download.'); } catch(_){}
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ar-comment.png'; document.body.appendChild(a); a.click(); a.remove();
      }
    }, 'image/png', 0.92);
  }catch(err){
    console.error(err);
    alert('Sorry, could not capture a screenshot on this device.');
  }
}

/* ========= Share modal helpers ========= */
function openShareModal(){ shareModal.classList.add('show'); }
function closeShareModal(){ shareModal.classList.remove('show'); }

/* ========= Small helpers ========= */
function roundedRect(ctx, x, y, w, h, r, fill){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
  if (fill) { ctx.fillStyle = fill; ctx.fill(); }
}
function drawWrappedText(ctx, text, x, y, maxW, lineH){
  const words = (text||'').split(/\s+/);
  let line = '', yy = y;
  for (let w of words){
    const test = line ? (line + ' ' + w) : w;
    const m = ctx.measureText(test).width;
    if (m > maxW && line){ ctx.fillText(line, x, yy); line = w; yy += lineH; }
    else line = test;
  }
  if (line) ctx.fillText(line, x, yy);
}
function escapeHtml(s){return (s||"").replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}
</script>
</body>
</html>
