<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AR Artwork ‚Äî Screen-Locked Bubbles</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .a-enter-vr,.a-enter-vr-button,.a-enter-ar,.a-enter-ar-button{display:none!important}
  /* hint + FAB */
  #hint{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;
        padding:6px 10px;border-radius:999px;z-index:6}
  #fab{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);width:68px;height:68px;border-radius:50%;
       background:radial-gradient(120% 120% at 30% 30%, #ffb2d9, #ffcf9a 55%, #b6c8ff);
       box-shadow:0 16px 40px rgba(255,160,200,.45), 0 6px 18px rgba(0,0,0,.35);
       border:1px solid rgba(255,255,255,.35); z-index:6; display:none}
  /* DOM bubbles (fixed on screen) */
  #bubbles{position:fixed;inset:0;pointer-events:none;z-index:5;display:none}
  .bubble{
    position:absolute; max-width:min(90vw,620px); color:#1a1a1a; pointer-events:auto;
    padding:14px 16px 38px; border-radius:22px; backdrop-filter:blur(10px);
    background:linear-gradient(180deg,#fff7f0 0%, #ffe9f6 100%); box-shadow:0 20px 50px rgba(0,0,0,.28);
    border:1px solid rgba(255,255,255,.6)
  }
  .bubble:after{ /* tail */
    content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-16px;
    width:34px; height:18px; background:linear-gradient(180deg,#fff7f0,#ffe9f6);
    clip-path:polygon(0 0,100% 0,50% 100%); filter:drop-shadow(0 8px 12px rgba(0,0,0,.15));
    border-bottom:1px solid rgba(255,255,255,.6); border-left:1px solid rgba(255,255,255,.6); border-right:1px solid rgba(255,255,255,.6);
    border-bottom-left-radius:6px;border-bottom-right-radius:6px;
  }
  .bubble h3{margin:0 0 6px; font-size:16px; font-weight:800; color:#2b232b}
  .bubble p{margin:0; line-height:1.25; color:#2b2b2b}
  .icons{position:absolute; left:14px; bottom:8px; display:flex; gap:14px; opacity:.9}
  .icon{width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center;
        background:#00000010; border:1px solid #00000012; border-radius:999px; cursor:pointer; user-select:none}
  .icon.liked{background:#ff99c51f; border-color:#ff99c560}
  .icon span{font-size:14px}
  /* positions */
  #bubbleTop{top:10%; left:6%}
  #bubbleBottom{bottom:12%; left:50%; transform:translateX(-50%)}
  /* Composer sheet */
  #composer{position:fixed;inset:0;display:none;z-index:10;
    background:linear-gradient(140deg,#ffd7bd 15%,#ffc6e0 85%);
    padding:calc(env(safe-area-inset-top) + 20px) 16px calc(env(safe-area-inset-bottom) + 24px)}
  #composer.show{display:block}
  .comp{max-width:560px;margin:0 auto;height:100%;display:flex;flex-direction:column}
  .title{font-weight:800;font-size:22px;text-align:center;color:#2b232b;margin-bottom:12px}
  .pill{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.86);border:1px solid rgba(0,0,0,.08);
        border-radius:18px;padding:10px 12px}
  .pill input{flex:1;border:0;outline:none;background:transparent;font-size:16px;color:#2b232b}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:12px auto 0;max-width:560px}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06);color:#503d49;cursor:pointer}
  .actions{margin-top:auto;display:flex;gap:10px;justify-content:center}
  .btn{padding:12px 16px;border-radius:14px;border:0;font-weight:700;cursor:pointer}
  .btn.primary{background:#2b232b;color:#fff}
  .btn.secondary{background:#ffffffcc;color:#2b232b}
</style>
</head>
<body>

<div id="hint">Point your camera at the artwork</div>
<div id="bubbles">
  <!-- Top (artist) -->
  <div id="bubbleTop" class="bubble">
    <h3>Zen ‚Äì the artist</h3>
    <p>‚ÄúThis piece explores the interplay of displacement, everyday objects and nostalgic wonder.‚Äù</p>
    <div class="icons">
      <div id="likeTop" class="icon" title="Like"><span>‚ù§Ô∏è</span></div>
      <div class="icon" title="Comment" id="cTop"><span>üí¨</span></div>
      <div class="icon" title="Share" id="sTop"><span>‚ÜóÔ∏é</span></div>
    </div>
  </div>
  <!-- Bottom (curator / latest visitor) -->
  <div id="bubbleBottom" class="bubble">
    <h3>Curator‚Äôs Note</h3>
    <p id="bottomText">‚ÄúA quiet yet defiant work that turns ordinary retail bags into a field for memory, resilience and becoming.‚Äù</p>
    <div class="icons">
      <div id="likeBottom" class="icon" title="Like"><span>‚ù§Ô∏è</span></div>
      <div class="icon" title="Comment" id="cBottom"><span>üí¨</span></div>
      <div class="icon" title="Share" id="sBottom"><span>‚ÜóÔ∏é</span></div>
    </div>
  </div>
</div>
<div id="fab" aria-label="Share your thoughts"></div>

<!-- Composer -->
<div id="composer" role="dialog" aria-modal="true">
  <div class="comp">
    <div class="title">What‚Äôs on your mind?</div>
    <div class="pill">
      <input id="compInput" placeholder="Add your thought‚Ä¶" maxlength="300"/>
      <button id="sendBtn" class="btn primary">Post</button>
    </div>
    <div class="chips" id="chipbar">
      <div class="chip">Happy</div><div class="chip">Grateful</div><div class="chip">Curious</div>
      <div class="chip">Calm</div><div class="chip">Excited</div><div class="chip">Inspired</div>
    </div>
    <div class="actions">
      <button id="closeComp" class="btn secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- AR scene -->
<a-scene id="scene"
         mindar-image="imageTargetSrc: ./targets%20(7).mind"
         renderer="colorManagement:true, physicallyCorrectLights:false"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true"
         embedded>
  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex: 0"></a-entity>
</a-scene>

<script>
  /* ====== CONFIG ====== */
  const TARGET_PATH = "./targets%20(7).mind"; // change if your .mind path differs
  document.getElementById("scene").setAttribute("mindar-image", `imageTargetSrc: ${TARGET_PATH}`);

  /* ====== Local state (2 bubbles max; bottom shows latest visitor) ====== */
  const ART_ID = "art1";
  const k = (n)=>`webar:${ART_ID}:${n}`;
  const load = (n, f)=>{ try{ return JSON.parse(localStorage.getItem(k(n))||JSON.stringify(f)); }catch{ return f; } };
  const save = (n, v)=> localStorage.setItem(k(n), JSON.stringify(v));
  let latest = load("latestComment", null);
  const bottomText = document.getElementById("bottomText");
  if (latest) bottomText.textContent = latest;

  /* ====== Make bubbles persistent on screen ====== */
  const bubbles = document.getElementById('bubbles');
  const fab = document.getElementById('fab');
  const hint = document.getElementById('hint');
  const anchor = document.getElementById('anchor');
  let shown = false; // show once when first detected

  anchor.addEventListener('targetFound', ()=>{
    if (shown) return;
    shown = true;
    hint.style.display = 'none';
    bubbles.style.display = 'block';   // FIXED DOM overlay ‚Äî won‚Äôt move with camera
    fab.style.display = 'block';
  });

  // Do NOT hide bubbles on lost ‚Äî keeps them on screen even when angle changes.
  anchor.addEventListener('targetLost', ()=>{ /* intentionally no-op */ });

  /* ====== Icons ====== */
  function toggleLike(btnId, storeKey){
    const el = document.getElementById(btnId);
    const liked = load(storeKey, false);
    if (liked) el.classList.add('liked'); else el.classList.remove('liked');
    el.addEventListener('click', ()=>{
      const now = !load(storeKey, false);
      save(storeKey, now);
      if (now) el.classList.add('liked'); else el.classList.remove('liked');
    });
  }
  toggleLike('likeTop', 'likedTop');
  toggleLike('likeBottom', 'likedBottom');

  function sharePage(){ const url = location.href;
    if (navigator.share) navigator.share({title:'AR Artwork', url}).catch(()=>{});
    else navigator.clipboard.writeText(url).then(()=>alert('Link copied'));
  }
  document.getElementById('sTop').onclick = sharePage;
  document.getElementById('sBottom').onclick = sharePage;

  /* ====== Composer ====== */
  const composer = document.getElementById('composer');
  const compInput = document.getElementById('compInput');
  const sendBtn = document.getElementById('sendBtn');
  const closeComp = document.getElementById('closeComp');
  const chipbar = document.getElementById('chipbar');

  function openComposer(){ composer.classList.add('show'); compInput.focus(); }
  function closeComposer(){ composer.classList.remove('show'); }
  fab.onclick = openComposer;
  document.getElementById('cTop').onclick = openComposer;
  document.getElementById('cBottom').onclick = openComposer;
  closeComp.onclick = closeComposer;
  chipbar.onclick = (e)=>{ if(e.target.classList.contains('chip')) {
    const t = e.target.textContent.trim();
    compInput.value = compInput.value ? (compInput.value + ' ' + t) : t;
    compInput.focus();
  }};
  function post(){
    const t = (compInput.value||"").trim(); if(!t) return;
    compInput.value = "";
    latest = t; save("latestComment", t);
    bottomText.textContent = t; // update bottom bubble with newest visitor comment
    closeComposer();
  }
  sendBtn.onclick = post;
</script>
</body>
</html>
