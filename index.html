<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AR Artwork + Comments</title>

<!-- A-Frame & MindAR -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

<style>
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .a-enter-vr,.a-enter-vr-button,.a-enter-ar,.a-enter-ar-button{display:none!important}
  #hint{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:999px;z-index:3}
  #hud{position:fixed;top:12px;left:12px;background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:10px;font-size:12px;z-index:3}
  #ui{position:fixed;left:0;right:0;bottom:0;padding:12px;background:rgba(0,0,0,.55);color:#fff;
      backdrop-filter:blur(6px);transform:translateY(110%);transition:.25s;z-index:3}
  #ui.show{transform:translateY(0)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:12px;border:0;background:#42a5f5;color:#000;font-weight:700;cursor:pointer}
  .btn.secondary{background:#30343a;color:#f2f6ff}
</style>
</head>
<body>

<!-- ===== CONFIG â€” change these 3 lines ===== -->
<script>
  // Better: rename to ./assets/art.mind and set that here.
  const TARGET_PATH   = "./targets%20(3).mind";
  const ADD_URL       = "https://docs.google.com/forms/d/e/1FAIpQLSeqRZbSpTWiVs9z6BzntH9ZFGW2LR_9BHIUM7bvAtvZdcdmPA/viewform";
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQKOqH_3Yl5Vpd-fPqtGgcHgLmq1dO6Pmnc9HuQ1LI2nBZm75Ms8mp1KQHcSQHp087pa7BLkY7BB8p/pub?output=csv";
</script>

<div id="hint">Point your camera at the artwork</div>
<div id="hud">Loadingâ€¦</div>

<!-- AR scene -->
<a-scene id="scene"
  mindar-image="imageTargetSrc: ./targets%20(3).mind"
  renderer="colorManagement:true, physicallyCorrectLights:true"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:true"
  embedded loading-screen="enabled:false">
  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex: 0"></a-entity>
</a-scene>

<!-- Bottom UI -->
<div id="ui">
  <div class="row">
    <button id="btn-form" class="btn">ðŸ’¬ Share your thoughts</button>
    <button id="btn-refresh" class="btn secondary">â†» Refresh comments</button>
    <span id="status" style="opacity:.85">Waiting for targetâ€¦</span>
  </div>
</div>

<!-- Google Form modal -->
<dialog id="formModal" style="border:0;border-radius:16px;max-width:min(900px,92vw);width:92vw;height:min(80vh,700px);padding:0;overflow:hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0f1116;color:#fff">
    <strong>Share your thoughts</strong>
    <button id="btn-close" class="btn secondary">Close</button>
  </div>
  <div style="height:calc(100% - 48px)"><iframe id="formFrame" title="Comment Form" src="about:blank" loading="lazy" style="width:100%;height:100%;border:0"></iframe></div>
</dialog>

<script>
  /* apply target from CONFIG */
  document.getElementById("scene").setAttribute("mindar-image", `imageTargetSrc: ${TARGET_PATH}`);

  const hud=document.getElementById('hud'), ui=document.getElementById('ui');
  const statusEl=document.getElementById('status'), hint=document.getElementById('hint');
  const anchor=document.getElementById('anchor'), modal=document.getElementById('formModal');
  const formFrame=document.getElementById('formFrame');

  // ===== CSV parsing + header matching =====
  function parseCSV(t){
    const rows=[], row=[], push=()=>rows.push(row.splice(0)); let cell="", q=false;
    for(let i=0;i<t.length;i++){const c=t[i],n=t[i+1];
      if(q){ if(c=='"'&&n=='"'){cell+='"'; i++;} else if(c=='"'){q=false;} else cell+=c; }
      else { if(c=='"') q=true; else if(c==','){row.push(cell);cell="";}
             else if(c=='\n'){row.push(cell);cell="";push();} else if(c!='\r'){cell+=c;} }
    } if(cell||row.length){row.push(cell);push();} return rows;
  }
  const normalize = s => (s||"").toLowerCase().replace(/[â€™']/g,"'").replace(/[^a-z0-9? ]+/g,'').trim();
  function findCol(headers, hints){
    const H = headers.map(h=>normalize(h));
    for(const h of hints){ const i = H.findIndex(x=>x.includes(normalize(h))); if(i>=0) return i; }
    return -1;
  }

  // Your sheet headers: "Timestamp", "What's on your mind?"
  const COMMENT_HINTS = ["what's on your mind?","whats on your mind","mind"];
  const NAME_HINTS    = []; // no name column
  const TIME_HINTS    = ["timestamp","time","date"];

  async function fetchRows(){
    const res = await fetch(SHEET_CSV_URL,{cache:"no-store"});
    if(!res.ok) throw new Error(`CSV HTTP ${res.status}`);
    return parseCSV(await res.text());
  }
  async function getComments(){
    const rows = await fetchRows();
    if(!rows.length) return [];
    const headers = rows[0];
    const ci = findCol(headers, COMMENT_HINTS);
    const ni = findCol(headers, NAME_HINTS); // unused but kept for future
    // const ti = findCol(headers, TIME_HINTS); // we don't show time anymore

    const items=[];
    for(let i=1;i<rows.length;i++){
      const r = rows[i] || [];
      const text = (ci>=0 ? r[ci] : "").trim();
      if(!text) continue;
      items.push({ text });
    }
    return items.reverse(); // newest first
  }
  async function getRowCountSafe(){
    try{ const rows = await fetchRows(); return Math.max(rows.length-1, 0); } catch{ return 0; }
  }

  // ===== Poll for a new submission, then close form + reset to page 1 =====
  function pollForNewSubmission(prevCount, timeoutMs, intervalMs, onNew){
    let aborted = false;
    (async ()=>{
      const start = Date.now();
      while(!aborted && Date.now()-start < timeoutMs){
        await new Promise(r=>setTimeout(r, intervalMs));
        try{
          const count = await getRowCountSafe();
          if (count > prevCount){ onNew(); return; }
        }catch{}
      }
    })();
    return () => { aborted = true; };
  }

  // --- open/close Google Form
  let pollAbort = null;
  document.getElementById('btn-form').onclick = async () => {
    if(!ADD_URL.startsWith("http")) return alert("Set ADD_URL to your Google Form.");
    try{ formFrame.src = ADD_URL; modal.showModal(); }catch{ window.open(ADD_URL,"_blank"); }
    const prev = await getRowCountSafe();
    pollAbort = pollForNewSubmission(prev, 45000, 2500, async () => {
      if (modal.open) modal.close();      // auto close
      await fetchAndRender(true);         // reset to page 1 (latest 3)
      statusEl.textContent = "Thanks! Your comment was added.";
    });
  };
  document.getElementById('btn-close').onclick = () => {
    if (pollAbort) { pollAbort(); pollAbort = null; }
    modal.close();
  };

  // ===== AR bubbles & paging (3 at a time) =====
  function clearBubbles(){ Array.from(anchor.children).forEach(ch=>anchor.removeChild(ch)); }
  const trunc=(s,n)=> s && s.length>n ? s.slice(0,n-1)+"â€¦" : (s||"");
  function placeBubble(item, pos){
    const g=document.createElement("a-entity"); g.setAttribute("position",`${pos.x} ${pos.y} ${pos.z}`);
    const card=document.createElement("a-plane");
    card.setAttribute("width",.68); card.setAttribute("height",.22);
    card.setAttribute("material","color:#ffb773;opacity:.92;transparent:true;side:double");
    const t=document.createElement("a-text");
    const label = trunc(item.text,80);   // â† COMMENT ONLY (no timestamp)
    t.setAttribute("value",label); t.setAttribute("align","center"); t.setAttribute("width",1.2); t.setAttribute("color","#222"); t.setAttribute("position","0 0 0.01");
    g.appendChild(card); g.appendChild(t); anchor.appendChild(g);
  }
  const pos=(ang,r,j=0)=>({x:Math.cos(ang)*r+(Math.random()-.5)*j, y:Math.sin(ang)*r+(Math.random()-.5)*j*.6, z:.02});

  const PAGE_SIZE = 3;
  let allComments=[], page=0;

  function renderPage(){
    clearBubbles();
    if(!allComments.length){ statusEl.textContent="No comments yet."; return; }
    const total = allComments.length, pages = Math.ceil(total/PAGE_SIZE);
    const start = page*PAGE_SIZE, end = Math.min(start+PAGE_SIZE,total);
    const items = allComments.slice(start,end);

    const R=.45, J=.08;
    items.forEach((it,i)=> placeBubble(it, pos((i/items.length)*2*Math.PI, R, J)) );

    statusEl.textContent = `Showing ${start+1}-${end} of ${total} (page ${page+1}/${pages}).`;
  }

  async function fetchAndRender(reset=true){
    try{
      hud.textContent = "Loading commentsâ€¦";
      allComments = await getComments();
      if(reset) page=0;
      renderPage();
      hud.textContent = `Loaded ${allComments.length} total.`;
    }catch(e){
      console.error(e);
      hud.textContent = "Could not load comments (publish CSV / link).";
      statusEl.textContent = "CSV error.";
    }
  }

  document.getElementById('btn-refresh').onclick = ()=>{
    if(!allComments.length){ fetchAndRender(true); return; }
    const totalPages = Math.ceil(allComments.length/PAGE_SIZE);
    page = (page+1) % totalPages;
    renderPage();
  };

  // ===== AR events: gate the UI =====
  anchor.addEventListener('targetFound', ()=>{
    hint.style.display='none'; ui.classList.add('show');
    statusEl.textContent="Target found. Loading commentsâ€¦";
    fetchAndRender(true);
  });
  anchor.addEventListener('targetLost',  ()=>{
    hint.style.display='block'; ui.classList.remove('show');
    statusEl.textContent="Waiting for targetâ€¦";
  });

  // quick target file check
  (async()=>{try{const r=await fetch(TARGET_PATH,{cache:"no-store"});hud.textContent=r.ok?"Target file âœ“ â€” aim at the artwork.":`Target file âœ— (${r.status})`;}catch{hud.textContent="Target file check failed."}})();
</script>
</body>
</html>
