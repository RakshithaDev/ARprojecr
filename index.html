<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Art AR + Comments (No Backend)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #ui{position:fixed;left:0;right:0;bottom:0;padding:12px;background:rgba(0,0,0,.55);color:#fff;backdrop-filter:blur(6px)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:12px;border:0;background:#42a5f5;color:#000;font-weight:700;cursor:pointer}
    .btn.secondary{background:#30343a;color:#f2f6ff}
    #hint{position:fixed;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:999px;font-size:14px}
    .hud{position:fixed;top:12px;left:12px;background:rgba(0,0,0,.55);color:#fff;padding:6px 10px;border-radius:10px;font-size:12px;white-space:pre-line;max-width:70ch}
  </style>
</head>
<body>
  <!-- ===== CONFIG: set these 3 lines ===== -->
  <script>
    // If you keep the spaced filename, use the URL-encoded path:
    const TARGET_PATH   = "./targets%20(3).mind"; // better: ./assets/art.mind
    const ADD_URL       = "https://docs.google.com/forms/d/XXXXXXXX/viewform";
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/XXXXXXXX/pub?output=csv&gid=YYYY";
    const MAX_BUBBLES   = 10;
    const HINT_COMMENT  = "comment", HINT_NAME="name", HINT_TIME="time";
  </script>

  <div id="hint">Point your camera at the artwork</div>
  <div id="hud" class="hud">Loadingâ€¦</div>

  <!-- AR scene -->
  <a-scene id="scene"
    mindar-image="imageTargetSrc: ./targets%20(3).mind"
    renderer="colorManagement:true, physicallyCorrectLights:true"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:true"
    embedded loading-screen="enabled:false">
    <a-camera look-controls="enabled:false"></a-camera>
    <a-entity id="anchor" mindar-image-target="targetIndex: 0"></a-entity>
  </a-scene>

  <!-- Bottom UI -->
  <div id="ui">
    <div class="row">
      <!-- Opens form in-page if allowed, otherwise new tab -->
      <button id="btn-form" class="btn">ðŸ’¬ Share your thoughts</button>
      <a id="link-form" class="btn secondary" href="#" target="_blank" rel="noopener" style="display:none">Open form in new tab</a>
      <button id="btn-refresh" class="btn secondary">â†» Refresh comments</button>
      <span id="status" style="opacity:.85">Waiting for targetâ€¦</span>
    </div>
  </div>

  <!-- Simple modal for the form (fallback to new tab if blocked) -->
  <dialog id="formModal" style="border:0;border-radius:16px;max-width:min(900px,92vw);width:92vw;height:min(80vh,700px);padding:0;overflow:hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0f1116;color:#fff">
      <strong>Share your thoughts</strong>
      <button id="btn-close" class="btn secondary">Close</button>
    </div>
    <div style="height:calc(100% - 48px)"><iframe id="formFrame" title="Comment Form" src="about:blank" loading="lazy" style="width:100%;height:100%;border:0"></iframe></div>
  </dialog>

  <script>
    // Apply the configured target path
    document.getElementById("scene").setAttribute("mindar-image", `imageTargetSrc: ${TARGET_PATH}`);

    const hud = document.getElementById('hud');
    const statusEl = document.getElementById('status');
    const hintEl   = document.getElementById('hint');
    const anchor   = document.getElementById('anchor');
    const modal    = document.getElementById('formModal');
    const formFrame= document.getElementById('formFrame');
    const linkForm = document.getElementById('link-form');

    // --- Button wiring
    document.getElementById('btn-form').onclick = () => {
      if (!ADD_URL.startsWith("http")) return alert("Set ADD_URL (Google Form) at the top.");
      try { formFrame.src = ADD_URL; modal.showModal(); }
      catch { window.open(ADD_URL, "_blank"); }
    };
    document.getElementById('btn-close').onclick = () => modal.close();
    document.getElementById('btn-refresh').onclick = () => fetchAndRender();
    // Always provide a new-tab link, in case dialogs/iframes are blocked
    if (ADD_URL.startsWith("http")) { linkForm.href = ADD_URL; linkForm.style.display = 'inline-block'; }

    // --- CSV fetch + parse
    function parseCSV(text){
      const rows=[]; let cell="", row=[], q=false;
      for(let i=0;i<text.length;i++){const c=text[i],n=text[i+1];
        if(q){ if(c=='"'&&n=='"'){cell+='"';i++;} else if(c=='"'){q=false;} else cell+=c; }
        else { if(c=='"'){q=true;} else if(c==','){row.push(cell);cell="";}
               else if(c=='\n'){row.push(cell); rows.push(row); row=[]; cell="";}
               else if(c!='\r'){cell+=c;} }
      } if(cell.length||row.length){row.push(cell); rows.push(row);}
      return rows;
    }
    const findCol = (hdrs,hint)=> hdrs.findIndex(h=> (h||"").toLowerCase().includes(hint));

    async function fetchComments(){
      if (!SHEET_CSV_URL.startsWith("http")) throw new Error("Set SHEET_CSV_URL to your Published Sheet CSV.");
      const res = await fetch(SHEET_CSV_URL, {cache:"no-store"});
      if (!res.ok) throw new Error(`CSV HTTP ${res.status}`);
      const text = await res.text();
      const rows = parseCSV(text);
      if (!rows.length) return [];
      const headers = rows[0].map(h=> (h||"").trim());
      const ci = findCol(headers, HINT_COMMENT), ni = findCol(headers, HINT_NAME), ti = findCol(headers, HINT_TIME);
      const out=[];
      for (let i=1;i<rows.length;i++){
        const r = rows[i]; const comment = (ci>=0 ? r[ci] : r[0] || "").trim();
        if (!comment) continue;
        out.push({ text: comment, name: ni>=0?(r[ni]||"").trim():"", time: ti>=0?(r[ti]||"").trim():"" });
      }
      return out.reverse(); // latest first
    }

    function clearBubbles(){ Array.from(anchor.children).forEach(ch=>anchor.removeChild(ch)); }
    const trunc = (s,n)=> s && s.length>n ? s.slice(0,n-1)+"â€¦" : (s||"");
    const pos = (ang,r,j=0)=> ({ x:Math.cos(ang)*r+(Math.random()-0.5)*j, y:Math.sin(ang)*r+(Math.random()-0.5)*j*0.6, z:0.02 });

    function addBubble(item, p){
      const g = document.createElement("a-entity");
      g.setAttribute("position", `${p.x} ${p.y} ${p.z}`);
      const card = document.createElement("a-plane");
      card.setAttribute("width", 0.68); card.setAttribute("height", 0.22);
      card.setAttribute("material","color:#ffb773;opacity:.92;transparent:true;side:double");
      const txt = document.createElement("a-text");
      const who = item.name?` â€” ${item.name}`:""; const when=item.time?` Â· ${item.time}`:"";
      txt.setAttribute("value", trunc(item.text,70)+who+when);
      txt.setAttribute("align","center"); txt.setAttribute("width",1.2); txt.setAttribute("color","#222"); txt.setAttribute("position","0 0 0.01");
      g.appendChild(card); g.appendChild(txt); anchor.appendChild(g);
    }

    async function fetchAndRender(){
      try{
        hud.textContent = "Fetching commentsâ€¦";
        const all = await fetchComments();
        clearBubbles();
        if (!all.length){ hud.textContent = "No comments yet. Use 'Share your thoughts' to add one."; return; }
        const items = all.slice(0, MAX_BUBBLES);
        const R=0.45, J=0.08;
        items.forEach((it,i)=> addBubble(it, pos(i/items.length*2*Math.PI, R, J)) );
        hud.textContent = `Showing ${items.length} comment${items.length===1?"":"s"}.`;
      } catch(e){
        console.error(e);
        hud.textContent = "Could not load comments (check CSV link/publish to web).";
      }
    }

    // AR events
    anchor.addEventListener('targetFound', ()=>{ hintEl.style.display='none'; statusEl.textContent="Target found."; fetchAndRender(); });
    anchor.addEventListener('targetLost',  ()=>{ hintEl.style.display='block'; statusEl.textContent="Waiting for targetâ€¦"; });

    // Quick sanity check on startup
    (async () => {
      try{
        const [mindRes] = await Promise.all([ fetch(TARGET_PATH, {cache:"no-store"}) ]);
        hud.textContent = mindRes.ok ? "Target file âœ“ â€” point at the artwork." : `Target file âœ— (${mindRes.status})`;
      }catch{ hud.textContent = "Target file check failed."; }
    })();
  </script>
</body>
</html>
